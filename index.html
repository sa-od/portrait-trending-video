<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Video Title Variations Generator</title>
    <!-- New Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20h9'%3E%3C/path%3E%3Cpath d='M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z'%3E%3C/path%3E%3C/svg%3E"
    />
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for the page */
      body {
        font-family: "Poppins", sans-serif;
      }
      /* Style for the drag-over effect */
      .drag-over {
        border-color: #4f46e5;
        background-color: #eef2ff;
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* Hide the default file input button */
      #video-upload-input {
        display: none;
      }
      /* Custom modal styles */
      .modal-backdrop {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      /* Custom styling for color radio buttons */
      .color-radio {
        -webkit-appearance: none;
        appearance: none;
        background-color: #fff;
        margin: 0;
        font: inherit;
        width: 1.5em;
        height: 1.5em;
        border: 0.15em solid currentColor;
        border-radius: 50%;
        transform: translateY(-0.075em);
        display: grid;
        place-content: center;
        cursor: pointer;
      }
      .color-radio::before {
        content: "";
        width: 0.75em;
        height: 0.75em;
        border-radius: 50%;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em var(--tw-shadow-color);
      }
      .color-radio:checked::before {
        transform: scale(1);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased">
    <div class="container mx-auto px-4 py-8 md:py-12">
      <!-- Header Section -->
      <header class="text-center mb-10">
        <h1 class="text-3xl md:text-4xl font-bold text-black">
          AI Video Title Variations Generator
        </h1>
        <p class="mt-2 text-lg text-gray-600">
          Create three versions of your video with different titles instantly.
        </p>
      </header>

      <main class="max-w-7xl mx-auto space-y-8">
        <!-- Step 1: Upload Video -->
        <section
          id="upload-section"
          class="bg-white rounded-2xl p-6 md:p-8 border border-gray-200 shadow-sm"
        >
          <h2 class="text-xl font-semibold text-black mb-4 flex items-center">
            <span
              class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 font-bold"
              >1</span
            >
            Upload Your Video
          </h2>
          <div
            id="drop-zone"
            class="mt-4 border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50"
          >
            <div class="flex flex-col items-center justify-center space-y-4">
              <svg
                class="w-12 h-12 text-gray-400"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
                />
              </svg>
              <p class="text-gray-500">
                <span class="font-semibold text-indigo-600"
                  >Click to upload</span
                >
                or drag and drop
              </p>
              <p class="text-xs text-gray-400">MP4, MOV, or WEBM (Max 100MB)</p>
            </div>
            <input
              type="file"
              id="video-upload-input"
              accept="video/mp4,video/quicktime,video/webm"
            />
          </div>
          <div id="upload-status" class="mt-4 text-center text-sm"></div>
        </section>

        <!-- Step 2: Enter Titles -->
        <section
          id="titles-section"
          class="bg-white rounded-2xl p-6 md:p-8 border border-gray-200 shadow-sm opacity-50 pointer-events-none transition-opacity duration-500"
        >
          <h2 class="text-xl font-semibold text-black mb-6 flex items-center">
            <span
              class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 font-bold"
              >2</span
            >
            Enter Title Variations
          </h2>

          <!-- AI Generation Section -->
          <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
            <label
              for="ai-topic"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Describe your video topic to generate titles with AI:</label
            >
            <div class="flex flex-col sm:flex-row gap-3">
              <input
                type="text"
                id="ai-topic"
                class="flex-grow bg-white border-gray-300 text-gray-900 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition"
                placeholder="e.g., A travel video about mountains"
              />
              <button
                id="ai-generate-btn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 shadow-sm transform hover:scale-105 flex items-center justify-center"
              >
                <span id="ai-btn-text">Generate with AI</span>
                <svg
                  id="ai-loading-spinner"
                  class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </button>
            </div>
            <div id="ai-status" class="mt-2 text-xs text-red-500"></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Title Input 1 -->
            <div>
              <label
                for="title1"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Title Variation 1</label
              >
              <input
                type="text"
                id="title1"
                name="title1"
                class="w-full bg-white border-gray-300 text-gray-900 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition"
                placeholder="e.g., OUR WEEKEND ADVENTURE"
              />
              <div
                class="flex items-center space-x-3 mt-3 color-palette"
                data-index="0"
              >
                <span class="text-sm font-medium text-gray-500">Color:</span>
                <input
                  type="radio"
                  name="color1"
                  value="white"
                  class="color-radio text-white shadow-gray-400"
                  checked
                />
                <input
                  type="radio"
                  name="color1"
                  value="red"
                  class="color-radio text-red-500 shadow-red-500"
                />
                <input
                  type="radio"
                  name="color1"
                  value="yellow"
                  class="color-radio text-yellow-400 shadow-yellow-400"
                />
                <input
                  type="radio"
                  name="color1"
                  value="lime"
                  class="color-radio text-lime-400 shadow-lime-400"
                />
                <input
                  type="radio"
                  name="color1"
                  value="black"
                  class="color-radio text-black shadow-black"
                />
              </div>
            </div>
            <!-- Title Input 2 -->
            <div>
              <label
                for="title2"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Title Variation 2</label
              >
              <input
                type="text"
                id="title2"
                name="title2"
                class="w-full bg-white border-gray-300 text-gray-900 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition"
                placeholder="e.g., EXPLORING THE MOUNTAINS"
              />
              <div
                class="flex items-center space-x-3 mt-3 color-palette"
                data-index="1"
              >
                <span class="text-sm font-medium text-gray-500">Color:</span>
                <input
                  type="radio"
                  name="color2"
                  value="white"
                  class="color-radio text-white shadow-gray-400"
                  checked
                />
                <input
                  type="radio"
                  name="color2"
                  value="red"
                  class="color-radio text-red-500 shadow-red-500"
                />
                <input
                  type="radio"
                  name="color2"
                  value="yellow"
                  class="color-radio text-yellow-400 shadow-yellow-400"
                />
                <input
                  type="radio"
                  name="color2"
                  value="lime"
                  class="color-radio text-lime-400 shadow-lime-400"
                />
                <input
                  type="radio"
                  name="color2"
                  value="black"
                  class="color-radio text-black shadow-black"
                />
              </div>
            </div>
            <!-- Title Input 3 -->
            <div>
              <label
                for="title3"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Title Variation 3</label
              >
              <input
                type="text"
                id="title3"
                name="title3"
                class="w-full bg-white border-gray-300 text-gray-900 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition"
                placeholder="e.g., UNFORGETTABLE MEMORIES"
              />
              <div
                class="flex items-center space-x-3 mt-3 color-palette"
                data-index="2"
              >
                <span class="text-sm font-medium text-gray-500">Color:</span>
                <input
                  type="radio"
                  name="color3"
                  value="white"
                  class="color-radio text-white shadow-gray-400"
                  checked
                />
                <input
                  type="radio"
                  name="color3"
                  value="red"
                  class="color-radio text-red-500 shadow-red-500"
                />
                <input
                  type="radio"
                  name="color3"
                  value="yellow"
                  class="color-radio text-yellow-400 shadow-yellow-400"
                />
                <input
                  type="radio"
                  name="color3"
                  value="lime"
                  class="color-radio text-lime-400 shadow-lime-400"
                />
                <input
                  type="radio"
                  name="color3"
                  value="black"
                  class="color-radio text-black shadow-black"
                />
              </div>
            </div>
          </div>
        </section>

        <!-- Step 3: Preview and Generate -->
        <section
          id="preview-section"
          class="bg-white rounded-2xl p-6 md:p-8 border border-gray-200 shadow-sm opacity-50 pointer-events-none transition-opacity duration-500"
        >
          <h2 class="text-xl font-semibold text-black mb-6 flex items-center">
            <span
              class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3 font-bold"
              >3</span
            >
            Preview & Generate
          </h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Preview Card 1 -->
            <div class="preview-card">
              <div
                class="relative bg-black rounded-lg overflow-hidden shadow-md"
              >
                <video class="w-full h-auto" muted loop playsinline></video>
                <div
                  class="absolute top-[6%] left-0 w-full text-center px-4 transition-all duration-300"
                >
                  <span
                    class="preview-title text-white text-5xl font-black uppercase"
                    style="
                      text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.9);
                      line-height: 1.2;
                    "
                  ></span>
                </div>
              </div>
              <p class="text-center mt-4 font-medium text-gray-700">
                Variation 1
              </p>
            </div>
            <!-- Preview Card 2 -->
            <div class="preview-card">
              <div
                class="relative bg-black rounded-lg overflow-hidden shadow-md"
              >
                <video class="w-full h-auto" muted loop playsinline></video>
                <div
                  class="absolute top-[6%] left-0 w-full text-center px-4 transition-all duration-300"
                >
                  <span
                    class="preview-title text-white text-5xl font-black uppercase"
                    style="
                      text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.9);
                      line-height: 1.2;
                    "
                  ></span>
                </div>
              </div>
              <p class="text-center mt-4 font-medium text-gray-700">
                Variation 2
              </p>
            </div>
            <!-- Preview Card 3 -->
            <div class="preview-card">
              <div
                class="relative bg-black rounded-lg overflow-hidden shadow-md"
              >
                <video class="w-full h-auto" muted loop playsinline></video>
                <div
                  class="absolute top-[6%] left-0 w-full text-center px-4 transition-all duration-300"
                >
                  <span
                    class="preview-title text-white text-5xl font-black uppercase"
                    style="
                      text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.9);
                      line-height: 1.2;
                    "
                  ></span>
                </div>
              </div>
              <p class="text-center mt-4 font-medium text-gray-700">
                Variation 3
              </p>
            </div>
          </div>

          <!-- Individual Generate & Download Buttons -->
          <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Button for Video 1 -->
            <div class="text-center">
              <button
                id="generate-btn-1"
                class="generate-individual-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg shadow-indigo-500/30 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 w-full"
                data-video-index="0"
              >
                Generate & Download
              </button>
              <p
                class="text-sm text-gray-600 mt-2 font-medium"
                id="title-display-1"
              >
                Enter title first
              </p>
            </div>

            <!-- Button for Video 2 -->
            <div class="text-center">
              <button
                id="generate-btn-2"
                class="generate-individual-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg shadow-indigo-500/30 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 w-full"
                data-video-index="1"
              >
                Generate & Download
              </button>
              <p
                class="text-sm text-gray-600 mt-2 font-medium"
                id="title-display-2"
              >
                Enter title first
              </p>
            </div>

            <!-- Button for Video 3 -->
            <div class="text-center">
              <button
                id="generate-btn-3"
                class="generate-individual-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg shadow-indigo-500/30 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 w-full"
                data-video-index="2"
              >
                Generate & Download
              </button>
              <p
                class="text-sm text-gray-600 mt-2 font-medium"
                id="title-display-3"
              >
                Enter title first
              </p>
            </div>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="text-center mt-12 text-gray-500 text-sm">
        <p>&copy; 2024 Video Variations Inc. All Rights Reserved.</p>
      </footer>
    </div>

    <!-- Custom Modal for Messages -->
    <div
      id="message-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop"
    >
      <div
        class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md border border-gray-200 modal-content transform scale-95"
      >
        <h3 id="modal-title" class="text-lg font-bold text-black">
          Notification
        </h3>
        <p id="modal-body" class="mt-2 text-gray-600">
          This is a UI demonstration.
        </p>
        <div class="mt-6 text-right">
          <button
            id="modal-close-btn"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- DOM Element References ---
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("video-upload-input");
      const uploadStatus = document.getElementById("upload-status");
      const titlesSection = document.getElementById("titles-section");
      const previewSection = document.getElementById("preview-section");
      const aiTopicInput = document.getElementById("ai-topic");
      const aiGenerateBtn = document.getElementById("ai-generate-btn");
      const aiBtnText = document.getElementById("ai-btn-text");
      const aiLoadingSpinner = document.getElementById("ai-loading-spinner");
      const aiStatus = document.getElementById("ai-status");
      const messageModal = document.getElementById("message-modal");
      const modalCloseBtn = document.getElementById("modal-close-btn");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");

      const titleInputs = [
        document.getElementById("title1"),
        document.getElementById("title2"),
        document.getElementById("title3"),
      ];

      const previewVideos = document.querySelectorAll(".preview-card video");
      const previewTitles = document.querySelectorAll(
        ".preview-card .preview-title"
      );
      const colorPalettes = document.querySelectorAll(".color-palette");
      const generateIndividualBtns = document.querySelectorAll(
        ".generate-individual-btn"
      );
      const titleDisplays = [
        document.getElementById("title-display-1"),
        document.getElementById("title-display-2"),
        document.getElementById("title-display-3"),
      ];

      // --- Event Listeners ---

      dropZone.addEventListener("click", () => fileInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("drag-over")
      );
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
      });

      fileInput.addEventListener("change", () => {
        if (fileInput.files.length) handleFile(fileInput.files[0]);
      });

      titleInputs.forEach((input, index) => {
        input.addEventListener("input", () => {
          const titleSpan = previewTitles[index];
          titleSpan.textContent = input.value;

          // Update the title display under the button
          if (titleDisplays[index]) {
            titleDisplays[index].textContent =
              input.value || "Enter title first";
          }

          // Adjust position and line-height based on line wrapping
          const titleContainer = titleSpan.parentElement;

          requestAnimationFrame(() => {
            // A single line of text-5xl is roughly 60px high. We use a threshold.
            if (titleSpan.offsetHeight > 70) {
              // Height indicative of two lines
              titleContainer.style.top = "4%";
              titleSpan.style.lineHeight = "0.9"; // Tighter line spacing for two lines
            } else {
              titleContainer.style.top = "6%";
              titleSpan.style.lineHeight = "1.2"; // Normal line spacing for one line
            }
          });
        });
      });

      colorPalettes.forEach((palette) => {
        palette.addEventListener("change", (e) => {
          if (e.target.type === "radio") {
            const index = palette.dataset.index;
            const color = e.target.value;
            previewTitles[index].style.color = color;
          }
        });
      });

      // Add event listeners for individual generate buttons
      generateIndividualBtns.forEach((btn) => {
        btn.addEventListener("click", handleIndividualVideoGeneration);
      });

      modalCloseBtn.addEventListener("click", hideModal);
      messageModal.addEventListener("click", (e) => {
        if (e.target === messageModal) hideModal();
      });
      aiGenerateBtn.addEventListener("click", handleAIGeneration);

      // --- Core Functions ---

      let uploadedVideoFile = null;
      let uploadedVideoInfo = null;

      /**
       * Handles the selected video file.
       * @param {File} file - The video file selected by the user.
       */
      async function handleFile(file) {
        if (!file.type.startsWith("video/")) {
          displayStatus("Error: Please select a valid video file.", "error");
          return;
        }
        const maxSize = 100 * 1024 * 1024;
        if (file.size > maxSize) {
          displayStatus(`Error: File size exceeds 100MB.`, "error");
          return;
        }

        try {
          displayStatus("Uploading video...", "success");

          // Upload video to backend
          const formData = new FormData();
          formData.append("video", file);

          const response = await fetch(
            "http://localhost:3000/api/upload-video",
            {
              method: "POST",
              body: formData,
            }
          );

          if (!response.ok) {
            throw new Error("Failed to upload video");
          }

          uploadedVideoInfo = await response.json();
          uploadedVideoFile = file;

          displayStatus(`Successfully uploaded: ${file.name}`, "success");

          const videoUrl = URL.createObjectURL(file);
          previewVideos.forEach((video) => {
            video.src = videoUrl;
            video
              .play()
              .catch((e) => console.error("Autoplay was prevented:", e));
          });

          enableSections();
        } catch (error) {
          console.error("Upload error:", error);
          displayStatus("Failed to upload video. Please try again.", "error");
        }
      }

      /**
       * Displays a status message to the user.
       * @param {string} message - The message to display.
       * @param {string} type - 'success' or 'error'.
       */
      function displayStatus(message, type) {
        uploadStatus.textContent = message;
        uploadStatus.className = `mt-4 text-center text-sm ${
          type === "success" ? "text-green-500" : "text-red-500"
        }`;
      }

      /**
       * Activates the title and preview sections of the UI.
       */
      function enableSections() {
        titlesSection.classList.remove("opacity-50", "pointer-events-none");
        previewSection.classList.remove("opacity-50", "pointer-events-none");
      }

      /**
       * Shows a custom modal with a message.
       * @param {string} title - The title for the modal.
       * @param {string} body - The body text for the modal.
       */
      function showModal(title, body) {
        modalTitle.textContent = title;
        modalBody.textContent = body;
        messageModal.classList.remove("hidden");
        setTimeout(() => {
          messageModal.classList.remove("opacity-0");
          messageModal
            .querySelector(".modal-content")
            .classList.remove("scale-95");
        }, 10);
      }

      /**
       * Hides the custom modal.
       */
      function hideModal() {
        messageModal.classList.add("opacity-0");
        messageModal.querySelector(".modal-content").classList.add("scale-95");
        setTimeout(() => {
          messageModal.classList.add("hidden");
        }, 300);
      }

      /**
       * Downloads a specific video.
       * @param {Object} video - Video object with download information.
       */
      async function downloadVideo(video) {
        try {
          const downloadResponse = await fetch(
            `http://localhost:3000${video.downloadUrl}`
          );
          if (downloadResponse.ok) {
            const blob = await downloadResponse.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = video.filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            throw new Error("Failed to download video");
          }
        } catch (error) {
          console.error("Download error:", error);
          showModal("Error", "Failed to download video. Please try again.");
        }
      }

      /**
       * Sets the loading state for the AI generate button.
       * @param {boolean} isLoading - Whether the button should be in a loading state.
       */
      function setAILoading(isLoading) {
        aiGenerateBtn.disabled = isLoading;
        aiBtnText.classList.toggle("hidden", isLoading);
        aiLoadingSpinner.classList.toggle("hidden", !isLoading);
        if (isLoading) aiStatus.textContent = "";
      }

      /**
       * Handles the AI title generation process.
       */
      async function handleAIGeneration() {
        const topic = aiTopicInput.value.trim();
        if (!topic) {
          aiStatus.textContent = "Please enter a topic for your video.";
          return;
        }
        setAILoading(true);
        const prompt = `Generate exactly 3 relatable, controversial, and hooky video titles based on this topic: '${topic}'. Each title must be 3 to 4 words long, in ALL CAPS. Do not use quotes.`;
        try {
          const result = await callBackendAPI(topic);
          if (result && result.titles && result.titles.length >= 3) {
            result.titles.slice(0, 3).forEach((title, index) => {
              titleInputs[index].value = title;
              // Update the title display under the button
              if (titleDisplays[index]) {
                titleDisplays[index].textContent = title;
              }
              // Manually dispatch the event to trigger the position adjustment logic
              titleInputs[index].dispatchEvent(
                new Event("input", { bubbles: true })
              );
            });
          } else {
            throw new Error("AI did not return the expected format.");
          }
        } catch (error) {
          console.error("AI Generation Error:", error);
          aiStatus.textContent = "Failed to generate titles. Please try again.";
        } finally {
          setAILoading(false);
        }
      }

      /**
       * Makes a fetch call to the backend API for AI title generation.
       * @param {string} topic - The topic to generate titles for.
       * @returns {Promise<object>} - The parsed JSON response from the API.
       */
      async function callBackendAPI(topic) {
        const apiUrl = "http://localhost:3000/api/generate-titles";
        const payload = { topic };

        let retries = 3;
        let delay = 1000;

        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              return await response.json();
            } else if (response.status === 429 || response.status >= 500) {
              await new Promise((resolve) => setTimeout(resolve, delay));
              delay *= 2;
            } else {
              throw new Error(
                `API request failed with status ${response.status}`
              );
            }
          } catch (error) {
            if (i === retries - 1) throw error;
            await new Promise((resolve) => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
        throw new Error("AI request failed after multiple retries.");
      }

      /**
       * Handles individual video generation and download.
       */
      async function handleIndividualVideoGeneration(event) {
        const button = event.currentTarget;
        const videoIndex = parseInt(button.dataset.videoIndex);

        if (!uploadedVideoInfo || !uploadedVideoFile) {
          showModal("Error", "Please upload a video first.");
          return;
        }

        const title = titleInputs[videoIndex].value.trim();
        if (!title) {
          showModal(
            "Error",
            `Please enter a title for Video ${videoIndex + 1}.`
          );
          return;
        }

        const colorPalette = colorPalettes[videoIndex];
        const checkedRadio = colorPalette.querySelector(
          'input[type="radio"]:checked'
        );
        const color = checkedRadio ? checkedRadio.value : "white";

        try {
          // Disable all buttons during generation
          generateIndividualBtns.forEach((btn) => {
            btn.disabled = true;
            btn.textContent = "Generating...";
          });

          const response = await fetch(
            "http://localhost:3000/api/generate-individual-video",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                videoFilename: uploadedVideoInfo.video.filename,
                title: title,
                color: color,
                videoIndex: videoIndex,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("Failed to generate video");
          }

          const result = await response.json();

          // Download the generated video immediately
          await downloadVideo(result);

          showModal(
            "Success",
            `Video ${videoIndex + 1} generated and downloaded successfully!`
          );
        } catch (error) {
          console.error("Video generation error:", error);
          showModal("Error", "Failed to generate video. Please try again.");
        } finally {
          // Re-enable all buttons
          generateIndividualBtns.forEach((btn, index) => {
            btn.disabled = false;
            btn.textContent = `Generate & Download Video ${index + 1}`;
          });
        }
      }
    </script>
  </body>
</html>
